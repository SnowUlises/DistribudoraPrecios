<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Distribuidora Funaz</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--green-apple:#7ED957;--bg:#f7fbf7;--card:#fff;--muted:#6b6b6b;--radius:12px}
    *{box-sizing:border-box}body{font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,var(--bg),#eef7ee);color:#0b2a12}
    header{display:flex;align-items:center;justify-content:center;padding:30px 0;background:linear-gradient(90deg,rgba(255,255,255,0.6),transparent);backdrop-filter: blur(4px)}
    .brand{display:flex;align-items:center;gap:18px}.logo{width:100%;max-width:520px}.logo img{width:100%;object-fit:contain}
    .wrap{max-width:1200px;margin:28px auto;padding:0 20px}.topbar{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px}
    .search{display:flex;gap:10px;align-items:center;flex:1;min-width:220px}.search input{padding:12px 14px;border-radius:10px;border:1px solid #dfeede;min-width:220px}
    .categories{display:flex;gap:8px;flex-wrap:wrap}.cat-btn{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .cat-btn:hover{transform:translateY(-2px)}.cat-btn.active{background:var(--green-apple);color:#05310b}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:18px}@media (max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}@media (max-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}@media (max-width:420px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 8px 22px rgba(18,64,22,0.06);display:flex;flex-direction:column;gap:10px;min-height:240px}
    .thumb{height:150px;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,rgba(126,217,87,0.12),rgba(126,217,87,0.04));display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover}.name{font-weight:700;color:#08330f;font-size:16px}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}.price{font-weight:800;color:#063b11;font-size:18px}.muted{color:var(--muted);font-size:13px}
    footer{margin:36px 0 80px;text-align:center;color:var(--muted)}.empty{padding:40px;border-radius:12px;background:#fff;text-align:center;color:var(--muted);box-shadow:0 6px 18px rgba(18,64,22,0.04)}
  </style>
</head>
<body>
  <header>
    <div class="brand" style="justify-content:center;width:100%">
      <div class="logo logo-wide">
        <img src="imagenes/logo.png" alt="Logo" onerror="this.src='imagenes/placeholder.png'">
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="topbar">
      <div class="search">
        <input id="search" placeholder="Buscar producto..." />
      </div>
      <div class="cat-wrapper">
        <div class="categories" id="categories"></div>
      </div>
    </div>

    <section id="productsArea">
      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;margin-top:18px">No se encontraron productos.</div>
    </section>

    <footer>¬© Distribuidora Funaz ‚Äî Pedidos: 2645583761 ¬∑ Consultas: 2645583761</footer>
  </main>

  <!-- Cargar Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = 'https://slroycxifwezthdomkny.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNscm95Y3hpZndlenRoZG9ta255Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNzIzNDIsImV4cCI6MjA3MTg0ODM0Mn0.OhgCTvtvdvOejXS9iXPX8rkg3Dh_jBkWObwhL-HnDB8';
    const FIXED_CATEGORIES = ["Todas", "Limpieza", "Higiene", "Perfumer√≠a", "Alimentos", "Accesorios"];
    // ----------------------------

    // ‚úÖ Cliente global
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM refs
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const search = document.getElementById('search');
    const categoriesEl = document.getElementById('categories');

    // state
    let PRODUCTS = [];
    let currentCategory = 'Todas';

    // helpers
    function formatMoney(n){
      return isNaN(n) ? '$0.00' : new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(n);
    }
    function normalizeCategory(c){ return c ? String(c).trim() : 'Otros'; }

    // card builder
    function createCard(p){
      const card = document.createElement('article'); card.className = 'card';
      const thumb = document.createElement('div'); thumb.className = 'thumb';
      const img = document.createElement('img');
      let imgPath = p.imagen || 'imagenes/placeholder.png';
      if (imgPath.startsWith('/')) imgPath = imgPath.slice(1);
      img.src = imgPath;
      img.alt = p.nombre || 'Producto';
      img.onerror = function(){ this.onerror=null; this.src='imagenes/placeholder.png'; };
      thumb.appendChild(img);

      const name = document.createElement('h3'); name.className='name'; name.textContent=p.nombre || 'Sin nombre';

      const meta = document.createElement('div'); meta.className='meta';
      const priceEl = document.createElement('div'); priceEl.className='price';
      const valor = Number(p.precio);
      priceEl.textContent = formatMoney((isNaN(valor) ? 0 : valor) * 1.10);
      const catEl = document.createElement('div'); catEl.className='muted'; catEl.textContent = p.categoria || '';
      meta.append(priceEl, catEl);

      card.append(thumb, name, meta);
      return card;
    }

    function renderProducts(list){
      grid.innerHTML = '';
      if(!list || !list.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      list.forEach(p => grid.appendChild(createCard(p)));
    }

    function buildCategoryButtons(){
      categoriesEl.innerHTML = '';
      FIXED_CATEGORIES.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'cat-btn' + (cat === currentCategory ? ' active' : '');
        btn.textContent = cat;
        btn.onclick = ()=>{ 
          currentCategory = cat; 
          document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); 
          btn.classList.add('active'); 
          applyFilters(); 
        };
        categoriesEl.appendChild(btn);
      });
    }

    function applyFilters(){
      const q = search.value.trim().toLowerCase();
      let list = PRODUCTS.slice();
      if(currentCategory && currentCategory !== 'Todas'){
        list = list.filter(p => normalizeCategory(p.categoria).toLowerCase() === currentCategory.toLowerCase());
      }
      if(q){
        list = list.filter(p => (p.nombre || '').toLowerCase().includes(q));
      }
      renderProducts(list);
    }

    // load productos
    async function load(){
      console.log('üîé Intentando cargar productos desde Supabase...');
      try {
        const { data, error } = await supa.from('productos').select('*').order('id', { ascending: true });
        if (error) throw error;
        if (data && data.length > 0) {
          console.log(`‚úÖ Supabase devolvi√≥ ${data.length} productos`);
          PRODUCTS = data.map(p => ({
            ...p,
            precio: (p.precio === null || p.precio === undefined) ? 0 : (isNaN(Number(p.precio)) ? parseFloat(String(p.precio).replace(',', '.')) || 0 : Number(p.precio)),
            categoria: normalizeCategory(p.categoria)
          }));
          buildCategoryButtons();
          applyFilters();
          return;
        } else {
          console.warn('‚ö†Ô∏è Supabase devolvi√≥ array vac√≠o.');
        }
      } catch (e) {
        console.error('‚ùå Error al consultar Supabase:', e.message || e);
      }

      // fallback productos.json
      console.log('üîé Intentando cargar productos desde productos.json...');
      try {
        const r = await fetch('productos.json', { cache: 'no-store' });
        if (r.ok) {
          const txt = await r.text();
          let parsed;
          try { parsed = JSON.parse(txt); }
          catch {
            let t = txt.trim().replace(/^[,\s]+/, '');
            if(!t.startsWith('[')) t = '[' + t;
            if(!t.endsWith(']')) t = t + ']';
            t = t.replace(/,\s*\]$/, ']');
            parsed = JSON.parse(t);
          }
          PRODUCTS = (Array.isArray(parsed) ? parsed : [parsed]).map(p => ({
            ...p,
            precio: (p.precio === null || p.precio === undefined) ? 0 : (isNaN(Number(p.precio)) ? parseFloat(String(p.precio).replace(',', '.')) || 0 : Number(p.precio)),
            categoria: normalizeCategory(p.categoria)
          }));
          console.log(`‚úÖ productos.json cargado (${PRODUCTS.length})`);
          buildCategoryButtons();
          applyFilters();
          return;
        } else {
          console.error('‚ùå productos.json no encontrado');
        }
      } catch (e) {
        console.error('Error cargando productos.json:', e.message || e);
      }

      console.error('‚ùå No hay datos disponibles');
    }

    search.addEventListener('input', applyFilters);
    load();
  </script>
</body>
</html>
